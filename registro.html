<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Registro - Eufolkia</title>
  <link rel="stylesheet" href="styles/registro.css"/>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
</head>
<body>
  <h1>Registro en Eufolkia</h1>

  <form id="formulario-registro">
    <label>Nombre:</label>
    <input type="text" id="nombre" required><br>

    <label>Apellidos:</label>
    <input type="text" id="apellidos" required><br>

    <label>Fecha de nacimiento:</label>
    <input type="date" id="fecha_nacimiento" required><br>

    <label>Sexo:</label>
    <select id="sexo" required>
      <option value="">Selecciona</option>
      <option value="masculino">Masculino</option>
      <option value="femenino">Femenino</option>
      <option value="otro">Otro</option>
    </select><br>

    <label>Usuario:</label>
    <input type="text" id="usuario" required><br>

    <label>Contraseña:</label>
    <input type="password" id="contrasena_hash" required><br>

    <label>Nivel:</label>
    <select id="nivel" required>
      <option value="">Selecciona</option>
      <option value="principiante">Principiante</option>
      <option value="intermedio">Intermedio</option>
      <option value="avanzado">Avanzado</option>
      <option value="profesional">Profesional</option>
    </select><br>

    <label>Género favorito:</label>
    <input type="text" id="genero_favorito"><br>

    <label>Instrumentos:</label><br>
    <input type="checkbox" name="instrumentos" value="piano">Piano<br>
    <input type="checkbox" name="instrumentos" value="guitarra">Guitarra<br>
    <input type="checkbox" name="instrumentos" value="violin">Violín<br>
    <input type="checkbox" name="instrumentos" value="bateria">Batería<br>
    <input type="checkbox" name="instrumentos" value="ukelele">Ukelele<br>
    <input type="checkbox" name="instrumentos" value="voz">Voz<br>

    <button type="submit">Registrarse</button>
  </form>

  <script>
    const supabase = supabase.createClient(
      "https://csfjdlxrckvmphyjueny.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNzZmpkbHhyY2t2bXBoeWp1ZW55Iiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1MTI0NjE2MCwiZXhwIjoyMDY2ODIyMTYwfQ.l2yNRPTdacnMHusGRfRZqqOen7KguXekSdhW5Mf-bNo"
    );

    document.getElementById("formulario-registro").addEventListener("submit", async function (event) {
      event.preventDefault();

      const instrumentosSeleccionados = Array.from(document.querySelectorAll('input[name="instrumentos"]:checked')).map(cb => cb.value);

      const { data: usuarioInsertado, error: errorUsuario } = await supabase
        .from("usuarios")
        .insert([{
          nombre: document.getElementById("nombre").value,
          apellidos: document.getElementById("apellidos").value,
          fecha_nacimiento: document.getElementById("fecha_nacimiento").value,
          sexo: document.getElementById("sexo").value,
          usuario: document.getElementById("usuario").value,
          contrasena_hash: document.getElementById("contrasena_hash").value,
          nivel: document.getElementById("nivel").value,
          genero_favorito: document.getElementById("genero_favorito").value
        }])
        .select()
        .single();

      if (errorUsuario) {
        alert("Error al registrar: " + errorUsuario.message);
        return;
      }

      for (let nombreInstrumento of instrumentosSeleccionados) {
        const { data: instrumento } = await supabase
          .from("instrumentos")
          .select("id")
          .eq("nombre", nombreInstrumento)
          .single();

        if (instrumento) {
          await supabase.from("usuario_instrumento").insert([{
            id_usuario: usuarioInsertado.id,
            id_instrumento: instrumento.id
          }]);
        }
      }

      alert("¡Registro exitoso!");
      window.location.href = "login.html";
    });
  </script>
</body>
</html>
